# Power BI Skill Migration: Readiness Analysis

**Analysis Date:** 2025-12-20
**Spec Version:** Draft (from SPEC.md)
**Status:** NOT READY FOR IMPLEMENTATION
**Estimated Additional Spec Work:** 8-16 hours

---

## Summary

The SPEC.md provides excellent strategic direction for converting the Power BI Analyst Plugin to a skill with MCP integration. However, significant gaps exist that would cause implementation failures. This document itemizes all gaps as actionable tasks.

---

## Task Tracking

### Legend
- [ ] Not started
- [x] Complete
- [~] In progress

---

## Section 1: Critical Gaps (Must Fix Before Implementation)

### 1.1 Complete Skill Prompt
**Priority:** P0 (Blocker)
**Effort:** 4-6 hours
**Status:** [x] Complete (2025-12-20)

**Current State:**
The `skill.md` is a 20-line placeholder skeleton that references non-existent agents (`agents/visual_analyst.md`, `agents/dax_specialist.md`).

**Required Deliverable:**
A complete skill prompt (200-400 lines) containing:

- [x] **1.1.1** Skill metadata block (name, description, allowed-tools, dependencies) → SPEC.md Section 7.0.1-7.0.3
- [x] **1.1.2** Session initialization logic (MCP detection, connection, state.json init) → SPEC.md Section 7.0.4
- [x] **1.1.3** Intent classification rules (map natural language to workflow type) → SPEC.md Section 7.0.5
- [x] **1.1.4** Workflow execution sections for all 6 command equivalents → SPEC.md Section 7.0.6
  - [x] Evaluate workflow (diagnose/fix)
  - [x] Create artifact workflow (new measures/columns/visuals)
  - [x] Create page workflow (new dashboard pages)
  - [x] Implement workflow (apply changes)
  - [x] Analyze workflow (document existing)
  - [x] Merge workflow (compare/merge projects)
- [x] **1.1.5** Specialist delegation rules (when to invoke DAX vs M-Code specialists) → SPEC.md Section 7.0.7
- [x] **1.1.6** State management patterns (state.json updates, task lifecycle) → SPEC.md Section 7.0.8 (TODO: complete schema)
- [x] **1.1.7** Error handling and fallback logic (MCP failure recovery) → SPEC.md Section 7.0.9
- [x] **1.1.8** Validation gate integration (DAX review, PBIR validation, TMDL syntax) → SPEC.md Section 7.0.10
- [x] **1.1.9** Human-in-the-loop confirmation patterns → SPEC.md Section 7.0.11
- [x] **1.1.10** Format-specific handling (PBIP vs PBIX vs pbi-tools extracted) → SPEC.md Section 7.0.12

**Acceptance Criteria:**
- Skill can be invoked with natural language requests
- Skill correctly routes to appropriate workflow
- Skill handles MCP unavailability gracefully

---

### 1.2 Intent Router Design
**Priority:** P0 (Blocker)
**Effort:** 2-3 hours
**Status:** [x] Complete (2025-12-21) → SPEC.md Section 7.0.5

**Current State:**
Complete intent classification logic documented in SPEC.md Section 7.0.5.

**Completed Deliverables:**

- [x] **1.2.1** Define intent categories → SPEC.md Section 7.0.5 Intent Categories table
  - EVALUATE, CREATE_ARTIFACT, CREATE_PAGE, IMPLEMENT, ANALYZE, MERGE

- [x] **1.2.2** Define keyword detection rules with priority ordering → SPEC.md Section 7.0.5 Intent Detection Flow

- [x] **1.2.3** Define ambiguity resolution prompts → SPEC.md Section 7.0.5 Ambiguity Clarification Template

- [x] **1.2.4** Define explicit override patterns → SPEC.md Section 7.0.5 Edge Cases table

- [x] **1.2.5** Create intent→workflow mapping table → SPEC.md Section 7.0.5 Intent Categories table
  - Includes Primary Keywords, Secondary Signals, and workflow routing

**Acceptance Criteria:**
- [x] Natural language requests are correctly classified
- [x] Ambiguous requests prompt for clarification
- [x] User can override classification

---

### 1.3 MCP Connection Bootstrap Flow
**Priority:** P0 (Blocker)
**Effort:** 3-4 hours
**Status:** [x] Complete (2025-12-21) → SPEC.md Sections 7.0.3, 7.0.4, 8 (Q4)

**Current State:**
Complete MCP connection bootstrapping documented across multiple SPEC.md sections.

**Completed Deliverables:**

- [x] **1.3.1** MCP availability detection → SPEC.md Section 7.0.3 MCP Detection Logic
  - Checks if `mcp__powerbi-modeling__*` tools are available
  - Sets mode = "mcp" or "file_fallback"

- [x] **1.3.2** Connection type selection flow → SPEC.md Section 7.0.4 MCP Connection Strategy: Lazy
  - Deferred until first MCP-requiring operation
  - Prompts user for Desktop/Fabric/PBIP when needed

- [x] **1.3.3** Per-connection-type initialization → SPEC.md Section 7.0.3 mcp_dependencies + Section 8 Q4
  - Desktop: Live Model connection for testing
  - Fabric: Live Model connection for testing
  - PBIP: Headless connection for editing (Git-friendly)

- [x] **1.3.4** Connection validation and retry logic → SPEC.md Section 7.0.9 Error Categories table
  - MCP Timeout: Retry once, then fallback

- [x] **1.3.5** Session persistence (connection caching) → SPEC.md Section 7.0.4
  - "Cache connection for remainder of session"

- [x] **1.3.6** Timeout handling → SPEC.md Section 7.0.9 Error Categories
  - MCP Timeout: Warning severity, retry once then fallback

- [x] **1.3.7** Credential requirements per connection type → SPEC.md Section 8 Q4
  - PBIP: No auth (file-based)
  - Desktop/Fabric: Auth handled by MCP

- [x] **1.3.8** Document MCP tool signatures → SPEC.md Appendix A MCP Tool Reference
  - Links to https://github.com/microsoft/powerbi-modeling-mcp

**Acceptance Criteria:**
- [x] Skill can establish MCP connection for all 3 connection types
- [x] Connection failures are handled gracefully with user feedback
- [x] Sessions persist connections appropriately

---

### 1.4 Specialist Agent Prompts
**Priority:** P0 (Blocker)
**Effort:** 3-4 hours
**Status:** [x] Complete (2025-12-21) → SPEC.md Section 7.0.7 + Agent Files

**Current State:**
Specialist delegation rules documented in SPEC.md Section 7.0.7.
Agent files created in `.claude/agents/`.

**Specification Complete (SPEC.md 7.0.7):**

- [x] Artifact → Specialist Mapping table
- [x] Delegation Flow diagram
- [x] Multi-Artifact Coordination pattern
- [x] Specialist Isolation Rules
- [x] MCP Tool Access by Specialist table

**Implementation Complete (Agent Files):**

#### 1.4.1 DAX Specialist Agent
- [x] Create `.claude/agents/powerbi-dax-specialist.md`
- [x] Define focus areas → SPEC.md Section 2.5.1 and 7.0.7
  - Time Intelligence, Filter Context, Performance, Relationships
- [x] Define input schema → SPEC.md Section 7.0.8.5 (reads Section 1 + state.json)
- [x] Define output schema → SPEC.md Section 7.0.8.5 (writes Section 2)
- [x] Define MCP tools available → SPEC.md Section 7.0.7 MCP Tool Access table
- [x] Include example invocations with expected outputs
- [x] Define validation checkpoint → SPEC.md Section 7.0.10.1 Measure Verification Protocol

#### 1.4.2 M-Code Specialist Agent
- [x] Create `.claude/agents/powerbi-mcode-specialist.md`
- [x] Define focus areas → SPEC.md Section 2.5.2
  - ETL, Query Folding, Privacy Levels, Data Types, Error Handling
- [x] Define input schema → SPEC.md Section 7.0.8.5 (reads Section 1 + state.json)
- [x] Define output schema → SPEC.md Section 7.0.8.5 (writes Section 3)
- [x] Define MCP tools available → SPEC.md Section 7.0.7 MCP Tool Access table
- [x] Include example invocations with expected outputs

**Acceptance Criteria:**
- [x] Specialist behavior is specified (SPEC.md 7.0.7)
- [x] Specialist agent .md files exist and can be invoked
- [x] Specialists produce validated code via MCP (Section 7.0.10.1)
- [x] Specialists use MCP for validation (Section 7.0.7)

---

### 1.5 State Schema Definition
**Priority:** P1 (High)
**Effort:** 2-3 hours
**Status:** [x] Complete (2025-12-20)

**Current State:**
Complete state schema now documented in SPEC.md Section 7.0.8.2.

**Completed Deliverables:**

- [x] **1.5.1** Define complete schema:
  ```json
  {
    "session": {
      "started": "ISO8601 timestamp",
      "skill_version": "1.0.0",
      "mcp_available": true,
      "connection_type": "desktop|fabric|pbip|file_fallback",
      "connection_status": "connected|disconnected|error",
      "connection_details": {
        "desktop_port": 12345,
        "fabric_workspace": "workspace-id",
        "fabric_dataset": "dataset-id",
        "pbip_path": "/path/to/project"
      }
    },
    "model_schema": {
      "tables": [...],
      "relationships": [...],
      "measures": [...],
      "last_synced": "ISO8601 timestamp"
    },
    "active_tasks": {
      "task-id-123": {
        "path": ".claude/tasks/task-id-123",
        "status": "in_progress|completed|failed",
        "workflow_type": "evaluate|create|implement|analyze|merge",
        "created": "ISO8601 timestamp",
        "updated": "ISO8601 timestamp"
      }
    },
    "resource_locks": {
      "definition/pages/Page1/visual.json": "task-id-123"
    },
    "validation_status": {
      "last_dax_validation": {...},
      "last_pbir_validation": {...},
      "last_tmdl_validation": {...}
    }
  }
  ```

- [x] **1.5.2** Define sync behavior (when does model_schema refresh from MCP?)
  → Documented in SPEC.md Section 7.0.8.7 (Model Schema Caching Strategy)

- [x] **1.5.3** Define lock acquisition/release patterns
  → Documented in SPEC.md Section 7.0.8.6 (Resource Locking Protocol)

- [x] **1.5.4** Define task lifecycle (create → in_progress → completed/failed → archived)
  → Documented in SPEC.md Section 7.0.8.4 (Task Lifecycle)

- [ ] **1.5.5** Update `state_manage.py` to implement full schema
  → TODO: Implementation work, spec complete

**Acceptance Criteria:**
- [x] state.json schema accurately defined
- [x] Model schema sync strategy documented
- [x] Concurrent task handling via locking documented
- [ ] `state_manage.py` implementation (Phase 2 work)

---

### 1.6 PBIR Format Handling
**Priority:** P1 (High)
**Effort:** 2-3 hours
**Status:** [x] Complete (2025-12-21) → SPEC.md Sections 7.0.12, 7.0.12.1, 7.0.12.2

**Current State:**
Complete PBIR format and schema version handling documented in SPEC.md.

**Completed Deliverables:**

- [x] **1.6.1** Schema version detection logic → SPEC.md Section 7.0.12.1
  - Parse `$schema` URL from definition.pbir and visual.json files
  - Extract version numbers (definitionProperties: 1.0.0/2.0.0, visualContainer: 2.0.0/2.2.0/2.4.0)
  - Python code pattern provided for extraction
  - Store in state.json `pbir_info` section

- [x] **1.6.2** Enhanced vs Legacy format detection → SPEC.md Section 7.0.12 + 7.0.12.1
  - Detects PBIP vs PBIX vs pbi-tools extracted vs model.bim
  - Detects PBIR-Enhanced (version 4.0+) vs PBIR-Legacy (version 1.0)
  - Shows conversion guidance for non-PBIP formats
  - Shows upgrade guidance for PBIR-Legacy projects

- [x] **1.6.3** Version-specific handling rules → SPEC.md Section 7.0.12.1 Compatibility Matrix
  | Project Schema | Template Schema | Status | Action |
  |----------------|-----------------|--------|--------|
  | 2.4.0 | 2.4.0 | ✅ Full | Proceed |
  | 2.2.0 | 2.4.0 | ⚠️ Compatible | Warn, proceed |
  | 2.0.0 | 2.4.0 | ⚠️ Compatible | Warn, proceed |
  | 3.0.0+ | 2.4.0 | ❌ Unknown | Halt, recommend skill update |

- [x] **1.6.4** Migration guidance → SPEC.md Section 7.0.12.1 PBIR-Legacy Detection
  - Upgrade instructions for PBIR-Legacy to PBIR-Enhanced
  - Warning about one-way upgrade (30-day backup created)

- [x] **1.6.5** Visual templates → Already using 2.4.0 schema in `.claude/visual-templates/`
  - Future version handling documented in Section 7.0.12.2

**Acceptance Criteria:**
- [x] Skill detects project format (PBIP/PBIX/pbi-tools)
- [x] Skill detects PBIR schema version within PBIP
- [x] User is warned about unsupported schema versions

---

### 1.7 Command→Workflow Mapping
**Priority:** P1 (High)
**Effort:** 2-3 hours
**Status:** [x] Complete (2025-12-21) → SPEC.md Appendix C

**Current State:**
Complete phase-by-phase mapping documented in SPEC.md Appendix C.

**Completed Deliverables:**

- [x] **1.7.1** `/evaluate-pbi-project-file` → Evaluate Workflow → SPEC.md Section C.1
  - 8 phases mapped with agent changes
  - Net: 2 removed, 1 replaced, 3 kept

- [x] **1.7.2** `/create-pbi-artifact` → Create Artifact Workflow → SPEC.md Section C.2
  - 7 phases mapped with specialist delegation
  - Net: 2 removed, 1 refactored, 2 added, 3 kept

- [x] **1.7.3** `/create-pbi-page-specs` → Create Page Workflow → SPEC.md Section C.3
  - 12 phases mapped
  - Net: 2 removed, 1 enhanced, 7 kept (all PBIR)

- [x] **1.7.4** `/implement-deploy-test-pbi-project-file` → Implement Workflow → SPEC.md Section C.4
  - 7 phases mapped with transaction pattern
  - Net: 2 removed, 1 enhanced, 3 kept

- [x] **1.7.5** `/analyze-pbi-dashboard` → Analyze Workflow → SPEC.md Section C.5
  - 5 phases mapped
  - Net: 1 removed, 1 enhanced

- [x] **1.7.6** `/merge-powerbi-projects` → Merge Workflow → SPEC.md Section C.6
  - 7 phases mapped with dual connection pattern
  - Net: 2 removed, 2 enhanced, 1 kept

- [x] **C.7** Agent Migration Matrix → Complete summary table
  - 7 REMOVED (replaced by MCP)
  - 3 ENHANCED (augmented with MCP)
  - 14 KEPT (LLM reasoning, PBIR, testing)
  - 2 ADDED (specialists)
  - **NET: 27 → 19 agents** (8 reduction)

**Acceptance Criteria:**
- [x] Every command phase has a skill equivalent
- [x] Agent changes are documented
- [x] No functionality is lost in migration

---

## Section 2: Structural Improvements

### 2.1 Fallback Mode Specification
**Priority:** P1 (High)
**Effort:** 2-3 hours
**Status:** [x] Complete (2025-12-21) → SPEC.md Section 7.0.9

**Current State:**
Complete fallback mode specification documented in SPEC.md Section 7.0.9.

**Completed Deliverables:**

- [x] **2.1.1** Define MCP unavailability detection → SPEC.md Section 7.0.9 Error Categories table
  - MCP Connection Failed: Warning severity
  - MCP Operation Failed: Warning severity
  - MCP Timeout: Warning severity, retry once then fallback

- [x] **2.1.2** Define automatic fallback trigger conditions → SPEC.md Section 7.0.9
  - Fallback triggered per-operation when MCP fails

- [x] **2.1.3** Define manual fallback override → SPEC.md Section 7.0.3 mcp_mode options
  - `preferred_with_fallback`: Default behavior
  - `required`: Fail fast if MCP unavailable
  - `optional`: File-based by default

- [x] **2.1.4** Define feature parity table → SPEC.md Section 7.0.9 Fallback Capability Matrix
  - Get measure, Validate DAX, Query data, Create measure, Deploy, Schema extraction

- [x] **2.1.5** Define degraded mode UX → SPEC.md Section 7.0.9 Fallback Warning Template
  - Per-operation warnings showing: Operation, MCP Status, Fallback method, Impact

- [x] **2.1.6** Document which agents are used → SPEC.md Appendix B Agent Mapping Reference
  - Maps each agent to MCP replacement or "KEEP" status

**Acceptance Criteria:**
- [x] Skill functions when MCP unavailable
- [x] User is informed of degraded capabilities
- [x] Fallback is seamless (per-operation)

---

### 2.2 Transaction Scope Resolution
**Priority:** P1 (High)
**Effort:** 1-2 hours
**Status:** [x] Complete (2025-12-21)

**Current State:**
SPEC.md Question 5 is RESOLVED. See SPEC.md Section 8 (Q5).

**Decision: Per-Workflow Transaction with Checkpoint Commits**

- [x] **2.2.1** Research MCP transaction_operations capabilities
  → MCP supports begin/commit/rollback via transaction_operations

- [x] **2.2.2** Define transaction strategy:
  → Option C (Hybrid): One transaction per workflow, with checkpoint commits for long workflows

- [x] **2.2.3** Document decision and rationale
  → See SPEC.md Section 8 (Q5)

- [x] **2.2.4** Define rollback behavior on partial failure
  → Automatic rollback via transaction_operations.rollback()

- [x] **2.2.5** Define user confirmation before commit
  → Confirmation required before IMPLEMENT workflow commits

**Acceptance Criteria:**
- [x] Transaction strategy is decided
- [x] Rollback behavior is defined
- [x] Error recovery path is clear

---

### 2.3 Version Control Integration
**Priority:** P1 (High)
**Effort:** 1-2 hours
**Status:** [x] Complete (2025-12-21)

**Current State:**
SPEC.md Question 4 is RESOLVED. See SPEC.md Section 8 (Q4).

**Decision: Option B - PBIP as Source of Truth with Live Model Testing**

- [x] **2.3.1** Evaluate pros/cons of each option
  → Evaluated: Option B ensures Git always has current state

- [x] **2.3.2** Document decision and rationale
  → PBIP files are primary target; Live Session is Test Bench only
  → Repository is always "Source of Truth"
  → Tests performed against actual code that will be deployed

- [x] **2.3.3** Define TMDL export workflow (if Option A):
  → N/A - Using Option B

- [x] **2.3.4** Define sync workflow (if Option B):
  → MCP PBIP connection writes directly to TMDL files (headless)
  → MCP Live connection (Desktop/Fabric) used for testing only
  → MCP refresh/reconnect picks up TMDL changes for testing

- [x] **2.3.5** Update current "versioned copy" pattern for MCP mode
  → Versioned copy still used for PBIR visual changes
  → MCP transactions provide rollback for semantic model changes

**Acceptance Criteria:**
- [x] Version control strategy is decided
- [x] Git-friendly workflow is defined
- [x] No data loss scenarios

---

### 2.4 Analytics/Testing Integration
**Priority:** P2 (Medium)
**Effort:** 1-2 hours
**Status:** [x] Complete (2025-12-21) → SPEC.md Section 7.0.14

**Current State:**
Analytics and testing integration fully documented in SPEC.md Section 7.0.14.

**Completed Deliverables:**

- [x] **2.4.1** Define analytics hook integration with skill → SPEC.md Section 7.0.14.1
  - Hook-based triggering (post-skill exit)
  - Same scripts (token_analyzer.py, analytics_merger.py)

- [x] **2.4.2** Define Playwright testing integration → SPEC.md Section 7.0.14.2
  - Keep `powerbi-playwright-tester` unchanged
  - Uses Playwright MCP for browser automation

- [x] **2.4.3** Document token_analyzer.py usage in skill context → SPEC.md Section 7.0.14.1
  - Same usage, hook-triggered
  - Parses Claude Code JSONL logs

- [x] **2.4.4** Define test result storage → SPEC.md Section 7.0.14.2-7.0.14.3
  - findings.md Section 6 for results
  - test-evidence/ folder for screenshots

**Acceptance Criteria:**
- [x] Analytics collection continues to work (hook-based, same scripts)
- [x] Playwright testing continues to work (agent unchanged)

---

### 2.5 Authentication Consolidation
**Priority:** P1 (High)
**Effort:** 2-3 hours
**Status:** [x] Complete (2025-12-21) → SPEC.md Section 7.0.13

**Current State:**
Authentication consolidation fully documented in SPEC.md Section 7.0.13.

**Completed Deliverables:**

- [x] **2.5.1** Document MCP authentication model → SPEC.md Section 7.0.13.2
  - Azure Identity SDK for all credential handling
  - DefaultAzureCredential chain

- [x] **2.5.2** Map current auth flows to MCP equivalent → SPEC.md Section 7.0.13.3
  | Current | MCP Equivalent | Notes |
  |---------|----------------|-------|
  | Device code (MSAL) | InteractiveBrowserCredential | Azure Identity handles flow |
  | Service principal | EnvironmentCredential | Set AZURE_* env vars |
  | PowerShell | Not needed | MCP handles internally |
  | Windows Integrated | Auto-detected | Used for Desktop connection |

- [x] **2.5.3** Define unified auth flow for skill → SPEC.md Section 7.0.13.4
  - PBIP: No auth
  - Desktop: Windows Integrated (automatic)
  - Fabric: Azure Identity SDK with credential chain

- [x] **2.5.4** Define credential storage/caching → SPEC.md Section 7.0.13.5
  - Azure Identity SDK manages caching
  - OS credential store (Windows Credential Manager)
  - Automatic token refresh

- [x] **2.5.5** Define auth error handling → SPEC.md Section 7.0.13.6
  - Error types and user messages
  - Recovery actions
  - Fabric tenant compatibility (7.0.13.7)

**Acceptance Criteria:**
- [x] Single auth flow for skill (Azure Identity SDK)
- [x] All current auth scenarios supported (mapped)
- [x] Auth errors handled gracefully (error templates)

---

## Section 3: Open Questions Resolution

### 3.1 Question 1: Offline Support
**Priority:** P2 (Medium)
**Status:** [x] Decided (2025-12-22) → SPEC.md Section 8 Q7

> Should we keep file-based agents for offline use when MCP is unavailable?

**Decision: Option A - Keep File-Based Agents as Fallback**

- [x] **3.1.1** Document decision → Yes, keep file-based agents
- [x] **3.1.2** Define offline mode trigger → MCP availability check (Section 7.0.9)
- [x] **3.1.3** Define fallback behavior → SPEC.md Q7

**Clarification:** "Offline" means MCP unavailable, not Desktop not running. PBIP folder mode via MCP is already headless.

**Rationale:**
- File-based agents already exist and work (current implementation)
- Minimal maintenance burden
- Users without MCP can still use skill in degraded mode

---

### 3.2 Question 2: PBIR via MCP
**Priority:** P3 (Low)
**Status:** [x] Decided (2025-12-22) → SPEC.md Section 8 Q8

> Will Microsoft add report support to MCP? If so, when?

**Decision: Option B - Monitor and Adapt**

- [x] **3.2.1** Document current limitation → MCP is semantic model only, no PBIR support
- [x] **3.2.2** Keep file-based PBIR agents → 7 agents retained
- [x] **3.2.3** Define monitoring plan → Check MCP repo quarterly for `report_operations`

**Summary:**
- Current: PBIR agents remain file-based (JSON editing)
- Future: If Microsoft adds PBIR support, evaluate migration
- Fallback: Keep file-based as backup per Q7 decision

---

### 3.3 Question 3: Skill Distribution
**Priority:** P2 (Medium)
**Status:** [x] Decided (2025-12-22) → SPEC.md Section 8 Q9

> How will we distribute the skill with MCP dependency?

**Decision: Option A (Manual) Now, Option D (Install Script) Later**

- [x] **3.3.1** Define distribution mechanism → Manual (clone/copy) for now
- [x] **3.3.2** Define MCP prerequisite documentation → README with setup steps
- [x] **3.3.3** Define version compatibility matrix → Future (after versions exist)

**Summary:**
- Phase 1: Manual installation (clone repo, copy `.claude/` folder)
- Phase 2: GitHub releases + install script (future enhancement)
- Focus on making skill work first, distribution polish later

---

### 3.4 Question 6: Error Recovery
**Priority:** P1 (High)
**Status:** [x] Decided (2025-12-21)

> If MCP fails mid-operation, what's the recovery path?

**Decision: Automatic Rollback + State Preservation + User Guidance**
→ See SPEC.md Section 8 (Q6)

- [x] **3.4.1** Define failure detection
  → Connection timeout, MCP validation response, transaction failure, JSON parse failure

- [x] **3.4.2** Define automatic retry policy
  → Retry once on connection timeout, then prompt user

- [x] **3.4.3** Define manual recovery guidance
  → Show error message, suggested fix, retry instructions

- [x] **3.4.4** Define state cleanup on failure
  → Auto-rollback via MCP, preserve findings.md, release locks, keep task for resume

---

## Section 4: Implementation Checklist

Once all gaps are addressed, use this checklist for implementation:

### Phase 1: Cleanup & Preparation
- [ ] Delete `.claude/agents/powerbi-code-fix-identifier.md`
- [ ] Delete `.claude/agents/power-bi-visual-edit-planner.md` (if exists with hyphen variant)
- [ ] Update README.md to remove references
- [ ] Verify no commands reference deprecated agents

### Phase 2: Core MCP Integration
- [ ] Create `.claude/helpers/mcp-connection.md`
- [ ] Create MCP-based verification (replace powerbi-verify-pbiproject-folder-setup)
- [ ] Create MCP-based schema extraction (replace powerbi-data-model-analyzer)
- [ ] Create MCP-based data context (replace powerbi-data-context-agent)
- [ ] Create MCP-based code locator (replace powerbi-code-locator)

### Phase 2.5: Specialist Agents
- [ ] Create `.claude/agents/powerbi-dax-specialist.md`
- [ ] Create `.claude/agents/powerbi-mcode-specialist.md`
- [ ] Refactor `.claude/agents/powerbi-artifact-designer.md` as Orchestrator

### Phase 3: Implementation Layer
- [ ] Create transaction-based implementation pattern
- [ ] Remove powerbi-tmdl-syntax-validator (MCP validates implicitly)
- [ ] Enhance powerbi-dax-review-agent with MCP validation

### Phase 4: Merge Workflow
- [ ] Enhance powerbi-compare-project-code with MCP
- [ ] Replace powerbi-code-merger with MCP transactions

### Phase 5: Pattern Discovery
- [ ] Enhance powerbi-pattern-discovery with MCP

### Phase 6: Skill Assembly
- [ ] Write complete skill.md
- [ ] Test skill invocation
- [ ] Verify all workflows work

### Phase 7: Command Migration
- [ ] Update /evaluate-pbi-project-file to use skill
- [ ] Update /create-pbi-artifact to use skill
- [ ] Update /create-pbi-page-specs to use skill
- [ ] Update /implement-deploy-test-pbi-project-file to use skill
- [ ] Update /analyze-pbi-dashboard to use skill
- [ ] Update /merge-powerbi-projects to use skill

### Phase 8: Cleanup
- [ ] Delete replaced agent files
- [ ] Delete Python TMDL parsing scripts (if not needed for PBIR)
- [ ] Delete Python XMLA scripts
- [ ] Update documentation

---

## Appendix A: File Inventory

### Files to Create
| File | Purpose | Spec Section |
|------|---------|--------------|
| `.claude/skills/powerbi-analyst/skill.md` | Main skill prompt | 1.1 |
| `.claude/agents/powerbi-dax-specialist.md` | DAX specialist agent | 1.4.1 |
| `.claude/agents/powerbi-mcode-specialist.md` | M-Code specialist agent | 1.4.2 |
| `.claude/helpers/mcp-connection.md` | MCP connection patterns | 1.3 |

### Files to Update
| File | Changes | Spec Section |
|------|---------|--------------|
| `specs/migrate_to_skill_and_pbi_mcp/skill.md` | Complete rewrite | 1.1 |
| `specs/migrate_to_skill_and_pbi_mcp/state_manage.py` | Implement full schema | 1.5.5 |
| `.claude/agents/powerbi-artifact-designer.md` | Refactor as Orchestrator | SPEC 2.5.3 |

### Files to Delete
| File | Reason | Spec Section |
|------|--------|--------------|
| `.claude/agents/powerbi-code-fix-identifier.md` | Deprecated | SPEC 1.1 |
| `.claude/agents/power-bi-visual-edit-planner.md` | Deprecated | SPEC 1.1 |

---

## Appendix B: Dependencies

### External Dependencies
| Dependency | Required For | Installation |
|------------|--------------|--------------|
| Power BI Modeling MCP | Core functionality | [GitHub](https://github.com/microsoft/powerbi-modeling-mcp) |
| Playwright MCP | Testing | Already configured |
| Python 3.x | PBIR editing, utilities | Already installed |

### Removed Dependencies (After Migration)
| Dependency | Replaced By |
|------------|-------------|
| pbi-tools CLI | MCP database_operations |
| Python XMLA scripts | MCP dax_query_operations |
| Python TMDL parsers | MCP table/column/measure_operations |

---

## Appendix C: Success Criteria

### Functional
- [ ] All 6 command workflows work with skill
- [ ] Can connect to Power BI Desktop
- [ ] Can connect to Fabric workspace
- [ ] Can connect to PBIP folder
- [ ] Transactions rollback on failure
- [ ] Deployment works via MCP
- [ ] PBIR agents work unchanged
- [ ] Fallback mode works when MCP unavailable

### Quality
- [ ] Agent count reduced from 27 to ~18
- [ ] No pbi-tools dependency for semantic model ops
- [ ] Python dependencies reduced
- [ ] Error messages are clear and actionable

### Documentation
- [ ] README updated with skill architecture
- [ ] Skill documentation complete
- [ ] Troubleshooting guide updated
- [ ] Breaking changes documented

---

## Revision History

| Date | Author | Changes |
|------|--------|---------|
| 2025-12-20 | Claude (analysis) | Initial readiness analysis |
| 2025-12-21 | Claude (sync) | Updated 1.2, 1.3, 1.4, 1.6, 2.1 to reflect SPEC.md coverage. Marked spec-complete vs needs-implementation.
| 2025-12-21 | Claude (spec) | Added SPEC.md Sections 7.0.12.1-7.0.12.2 for PBIR schema version detection. Corrected version numbers (2.0.0-2.4.0 not 1.0.0-1.2.0).
| 2025-12-21 | Claude (spec) | Added SPEC.md Appendix C: Command→Workflow Phase Mapping. Marked 1.7 complete.
| 2025-12-21 | Claude (impl) | Created `.claude/agents/powerbi-dax-specialist.md` and `.claude/agents/powerbi-mcode-specialist.md`. Marked 1.4 complete.
| 2025-12-21 | Claude (spec) | Added SPEC.md Section 7.0.13 (Authentication Consolidation). Marked 2.5 complete.
| 2025-12-21 | Claude (spec) | Added SPEC.md Section 7.0.14 (Analytics/Testing Integration). Marked 2.4 complete.
| 2025-12-22 | Claude (decision) | Resolved Q7 Offline Support: Keep file-based agents as fallback. Marked 3.1 complete.
| 2025-12-22 | Claude (decision) | Resolved Q8 PBIR via MCP: Monitor and adapt. Marked 3.2 complete.
| 2025-12-22 | Claude (decision) | Resolved Q9 Skill Distribution: Manual now, install script later. Marked 3.3 complete.
