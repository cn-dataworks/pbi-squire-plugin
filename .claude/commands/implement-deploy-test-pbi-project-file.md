---
name: implement-deploy-test-pbi-project-file
description: Implement Power BI code changes from an analyst findings report by applying changes to a versioned project, optionally deploying to Power BI Service, and running automated tests
pattern: ^/implement-deploy-test-pbi-project-file\s+(.+)$
---

# Implement, Deploy, and Test Power BI Project

This slash command orchestrates the complete implementation workflow for Power BI code changes by:
1. Applying proposed changes to a versioned copy of the project
2. Validating DAX syntax and semantics of modified code
3. Optionally deploying the updated project to Power BI Service via pbi-tools
4. Running automated Playwright tests against the deployed dashboard
5. Consolidating all results into the original findings document

## Usage

```bash
/implement-deploy-test-pbi-project-file --findings "<path-to-findings.md>" [--deploy "<environment>"] [--dashboard-url "<url>"]
```

### Parameters

- `--findings` (required): Path to the findings.md file generated by `/evaluate-pbi-project-file`
- `--deploy` (optional): Environment name for deployment (e.g., "DEV", "TEST", "PROD")
- `--dashboard-url` (optional): URL of deployed dashboard for testing (if omitted, extracted from deployment output or skipped)

### Examples

```bash
# Apply changes only (no deployment or testing)
/implement-deploy-test-pbi-project-file --findings "agent_scratchpads/20251003-071759-pssr-misc/findings.md"

# Apply changes and deploy to DEV environment
/implement-deploy-test-pbi-project-file --findings "agent_scratchpads/20251003-071759-pssr-misc/findings.md" --deploy "DEV"

# Apply, deploy, and test against specific URL
/implement-deploy-test-pbi-project-file --findings "agent_scratchpads/20251003-071759-pssr-misc/findings.md" --deploy "PROD" --dashboard-url "https://app.powerbi.com/reports/abc123"

# Apply and test without deployment (manual deployment)
/implement-deploy-test-pbi-project-file --findings "agent_scratchpads/20251003-071759-pssr-misc/findings.md" --dashboard-url "https://app.powerbi.com/reports/abc123"
```

## Workflow

### Phase 1: Validation & Setup

1. **Parse Arguments**
   - Extract `--findings` path
   - Extract optional `--deploy` environment name
   - Extract optional `--dashboard-url`

2. **Validate Findings File**
   - Verify findings.md exists at specified path
   - Read findings.md to extract metadata:
     - **Project Path**: From "Project:" metadata line
     - **Problem Statement**: For context
     - **Section 2**: Verify proposed changes exist
     - **Section 3**: Check for test cases (optional)

3. **Validate Project**
   - Verify project path extracted from findings.md exists
   - Confirm it's a valid Power BI project structure (.pbip or .SemanticModel)

4. **Determine Scratchpad Folder**
   - Extract parent directory of findings.md (e.g., `agent_scratchpads/20251003-071759-pssr-misc/`)
   - This folder will receive test results

### Phase 2: Apply Changes (Conditional - Code and/or Visual)

**Condition:** This phase executes conditionally based on what exists in Section 2:
- If Section 2.A exists ‚Üí Apply code changes
- If Section 2.B exists ‚Üí Apply visual changes (after code changes)
- If both exist (hybrid) ‚Üí Apply code FIRST, then visual changes

---

#### Phase 2a: Apply Code Changes (Conditional)

**Condition:** Only runs if Section 2.A (Calculation Changes) exists in findings.md

**Invoke:** `powerbi-code-implementer-apply` agent

**Inputs:**
- Findings file path
- Project path (from findings.md metadata)
- **NO deployment flag** (deployment moved to Phase 4)

**Agent Actions:**
1. Create timestamped versioned copy of project
2. Apply all changes from Section 2.A of findings.md
3. Verify all code modifications completed successfully

**Success Criteria:**
- Timestamped project created successfully
- All code changes applied without errors

**Failure Handling:**
- **Code Application Fails**: ABORT entire workflow, report error

**Outputs:**
- Path to versioned project
- List of modified objects
- Application status (success/failed)

---

#### Phase 2b: Apply Visual Changes (Conditional)

**Condition:** Only runs if Section 2.B (Visual Changes) exists in findings.md

**Prerequisites:**
- If Section 2.A was executed ‚Üí Use versioned project path from Phase 2a
- If Section 2.A was NOT executed ‚Üí Create versioned project first

**Invoke:** `powerbi-visual-implementer-apply` agent

**Inputs:**
- Findings file path
- Versioned project path (from Phase 2a or newly created)

**Agent Actions:**
1. Verify .Report folder exists (PBIR format required)
2. Parse XML edit plan from Section 2.B
3. Execute XML edit plan using `pbir_visual_editor.py`
4. Modify visual.json files according to edit operations
5. Verify all visual modifications completed successfully

**Operation Types:**
- `replace_property`: Modify top-level visual.json properties (x, y, width, height, visualType)
- `config_edit`: Modify properties inside stringified config blob (title.text, colors, fonts)

**Success Criteria:**
- All visual.json files modified successfully
- All JSON structures remain valid
- All config strings parseable

**Failure Handling:**
- **Visual Application Fails**: Log error, continue if partial success, ABORT if critical failure
- **No .Report Folder**: ABORT with error message: "Visual changes require Power BI Project (.pbip) format with .Report folder"

**Outputs:**
- List of modified visuals
- Operation count per visual
- Application status (success/partial/failed)

**Why This Phase Runs After Code Changes:**
Visuals may reference measures or columns created in Phase 2a. Running code changes first ensures these references are valid when visual changes are applied.

---

### Phase 2.5: TMDL Format Validation (Quality Gate - Conditional)

**Condition:** Only runs if Phase 2a (code changes) was executed

**Invoke:** `powerbi-tmdl-syntax-validator` agent

**Inputs:**
- Versioned project path (from Phase 2a output)
- List of modified TMDL files (from Phase 2a output)
- Context about what was changed

**Agent Actions:**
1. For each modified TMDL file, run format validation
2. Execute Python validator: `.claude/tools/tmdl_format_validator.py`
3. Check indentation consistency (tabs, proper levels)
4. Verify property placement (formatString, displayFolder, etc.)
5. Ensure properties are outside DAX expression blocks
6. Validate TMDL structure and syntax

**Validation Outcomes:**
- **‚úÖ PASS**: All format checks passed ‚Üí Proceed to Phase 3 (DAX Validation)
- **‚úÖ FIXED**: TMDL012 warnings auto-fixed with triple backticks ‚Üí Proceed to Phase 3
- **‚ùå FAIL**: Format errors found (including TMDL013 duplicate properties) ‚Üí Must fix before proceeding

**Auto-Fix Handling:**
When TMDL012 warnings are detected (properties at DAX indentation level), the validator automatically:
1. **Checks for duplicate properties FIRST** (TMDL013 check)
   - If duplicates found ‚Üí Report as ERROR, halt workflow (cannot auto-fix)
   - If no duplicates ‚Üí Proceed with auto-fix
2. **Adds triple backticks** to affected measures to remove structural ambiguity
3. **Re-validates** to confirm fix successful
4. **Reports what was fixed** and proceeds to Phase 3

This auto-fix is safe because:
- Preserves DAX logic exactly (no behavior change)
- Follows Power BI best practices
- Prevents Power BI Desktop loading issues
- No user intervention needed

**Why This Phase Is Critical:**
- TMDL format errors prevent Power BI Desktop from opening the file
- Catches indentation issues that cause "unsupported property" errors
- Auto-fixes TMDL012 warnings proactively (adds backticks for clarity)
- Detects duplicate properties (TMDL013) that indicate deeper issues
- Validates BEFORE DAX logic, saving time on debugging
- Quick validation (runs in seconds)

**Failure Handling:**
- **Format Validation FAIL (TMDL001-TMDL010)**: Report specific line numbers and indentation errors
- **Duplicate Properties Detected (TMDL013)**: Report ERROR with line numbers, halt workflow
  - Duplicates indicate merge conflict or code generation error
  - Must be manually resolved - cannot auto-fix
  - User must remove duplicate properties, then re-run Phase 2 and 2.5
- **TMDL012 Warnings**: Automatically fixed with triple backticks (no user action)
- **Provide Fix Guidance**: Show exact tab counts needed for each property error
- **Halt Workflow**: Do not proceed to DAX validation until format is correct
- **User Fixes**: User corrects indentation/duplicates, then re-runs Phase 2.5

**Success Criteria:**
- All TMDL files pass format validation
- No indentation errors
- Properties correctly placed outside DAX blocks
- Ready for Power BI Desktop to parse

**Outputs:**
- Format validation verdict (PASS/FAIL)
- List of format errors with line numbers (if any)
- Remediation guidance for each error
- Recommendation to proceed or fix

---

### Phase 2.6: PBIR Visual Validation (Quality Gate - Conditional)

**Condition:** Only runs if Phase 2b (visual changes) was executed

**Invoke:** `powerbi-pbir-validator` agent

**Inputs:**
- Findings file path (for Section 2.B: Visual Changes)
- Versioned project path (from Phase 2a or 2b output)

**Agent Actions:**
1. Parse Section 2.B to identify modified visuals
2. For each modified visual.json file:
   - Validate JSON structure
   - Verify config string is valid JSON (if present)
   - Check property types match schema
   - Validate position object (x, y, z, width, height, tabOrder)
   - Verify modified properties have correct values
3. Cross-reference measure dependencies with Section 2.A (if applicable)
4. Generate Section 2.6: PBIR Validation Report in findings.md

**Validation Checks:**
- ‚úÖ JSON syntax valid
- ‚úÖ Config string parseable
- ‚úÖ Required properties present
- ‚úÖ Property data types correct
- ‚úÖ Measure references valid (cross-check with Section 2.A)
- ‚úÖ Modified operations successful

**Validation Outcomes:**
- **‚úÖ PASS**: All checks passed ‚Üí Proceed to Phase 3 (DAX Validation if applicable, otherwise deployment)
- **‚ö†Ô∏è WARNINGS**: Non-critical issues ‚Üí User decides to proceed or fix
- **‚ùå FAIL**: Critical errors ‚Üí Must fix before proceeding

**Why This Phase Is Critical:**
- PBIR JSON errors prevent Power BI from loading visuals
- Config blob errors cause visual rendering failures
- Property type mismatches lead to unexpected behavior
- Quick validation (runs in seconds)

**Failure Handling:**
- **Validation FAIL**: Report specific visual names and errors
- **Provide Fix Guidance**: Show exact property paths and expected values
- **Halt Workflow**: Do not proceed to deployment until errors fixed
- **User Fixes**: User corrects Section 2.B XML edit plan, re-runs Phase 2b and 2.6

**Success Criteria:**
- All modified visual.json files pass validation
- No JSON structure errors
- Config strings parseable
- Property values correct
- Ready for Power BI to render visuals

**Outputs:**
- Validation verdict (PASS/WARNINGS/FAIL)
- Section 2.6 added to findings.md with detailed validation report
- List of issues found (if any)
- Recommendation to proceed or fix

---

### Phase 3: DAX Validation (Quality Gate - Conditional)

**Condition:** Only runs if Phase 2a (code changes) was executed

**Invoke:** `powerbi-dax-review-agent` agent

**Inputs:**
- Findings file path (for Section 2.A: Calculation Changes)
- Versioned project path (from Phase 2a output)

**Agent Actions:**
1. Parse Section 2 to identify modified objects (measures, columns, tables)
2. Extract DAX code for ONLY the modified objects from TMDL files
3. Perform syntax validation on extracted DAX
4. Check for semantic issues (invalid references, circular dependencies)
5. Analyze runtime risks (division by zero, type mismatches)
6. Verify specification compliance (code matches Section 2)
7. Generate Section 2.5: DAX Validation Report in findings.md

**Validation Outcomes:**
- **‚úÖ PASS**: All checks passed ‚Üí Proceed to Phase 4 (Deployment)
- **‚ö†Ô∏è WARNINGS**: Non-critical issues ‚Üí User decides to proceed or fix
- **‚ùå FAIL**: Critical errors ‚Üí Must fix before deployment

**Feedback Loop (If FAIL):**
1. User reviews Section 2.5 validation report
2. User updates Section 2 with corrected "Proposed Code"
3. Re-run Phase 2 (powerbi-code-implementer-apply) with fixes
4. Re-run Phase 3 (powerbi-dax-review-agent) to validate
5. Repeat until PASS or accepted WARNINGS

**Success Criteria:**
- Validation report generated (Section 2.5 added to findings.md)
- Verdict determined (PASS/WARNINGS/FAIL)
- If FAIL: User acknowledges need to fix and loop back
- If PASS/WARNINGS: User approves proceeding to deployment

**Failure Handling:**
- **Validation FAIL + User Chooses to Fix**: Loop back to Phase 2 with updated Section 2
- **Validation FAIL + User Chooses to Abort**: Stop workflow, provide manual fix guidance
- **WARNINGS + User Accepts Risk**: Proceed to Phase 4
- **Cannot Parse TMDL Files**: ABORT workflow, report technical issue

**Outputs:**
- Validation verdict (PASS/WARNINGS/FAIL)
- Section 2.5 added to findings.md with detailed validation report
- List of issues found (if any)
- Recommendation to proceed or fix

---

### Phase 4: Deployment (OPTIONAL - If Requested)

**Condition:** Only runs if:
- `--deploy` parameter was provided, AND
- Phase 3 validation resulted in PASS or accepted WARNINGS

**Invoke:** Deployment logic (via implementer-apply agent or direct commands)

**Inputs:**
- Versioned project path (from Phase 2)
- Deployment environment name (from `--deploy` parameter)
- User authentication or service principal credentials

**Actions:**
1. Check for `.pbixproj.json` deployment manifest
2. If not found, interactively configure deployment profile
3. Guide user through service principal setup (if needed)
4. Execute deployment via:
   - **User Authentication**: PowerShell cmdlets
   - **Service Principal**: `pbi-tools deploy . <environment>`
5. Capture deployed dashboard URL from output

**Success Criteria:**
- Deployment completed successfully
- Dashboard URL captured

**Failure Handling:**
- **Deployment Fails**: Log error, ask user if they want to continue to testing with manual deployment
- **User Skips Deployment**: Log as skipped, continue to Phase 5 if URL provided

**Outputs:**
- Deployment status (success/failed/skipped)
- Deployed dashboard URL (if deployment succeeded)

---

### Phase 5: Testing (OPTIONAL - Runs if URL Available)

**Condition:** Only runs if:
- `--dashboard-url` parameter was provided, OR
- Deployment in Phase 4 returned a dashboard URL

**Invoke:** `powerbi-playwright-tester` agent

**Inputs:**
- Findings file path (for test plan in Section 3)
- Dashboard URL
- Test results directory: `<scratchpad-folder>/test-results/`

**Agent Actions:**
1. Create `test-results/` subfolder in scratchpad directory
2. Read Section 3 of findings.md for test cases
3. If Section 3 has test cases:
   - Execute each test case via Playwright
   - Capture screenshots to `test-results/screenshots/`
   - Generate `test-results/test_results.md`
4. If Section 3 missing or has no test cases:
   - Navigate to dashboard URL
   - Take screenshot of default view
   - Save as `TestCase_Default_Dashboard_View.png`
   - Mark as PASS (visual verification only)

**Failure Handling:**
- Individual test failures: LOG in test results (don't abort)
- Playwright errors: LOG error, mark affected tests as ERROR
- Dashboard inaccessible: LOG error, skip testing phase

**Outputs:**
- Test results markdown file
- Screenshot files
- Pass/fail summary

### Phase 6: Consolidate Results

Update the original findings.md file with a new **Section 4: Implementation Results**:

```markdown
## Section 4: Implementation Results

**Implementation Date**: YYYY-MM-DD HH:MM:SS
**Versioned Project**: [path-to-timestamped-project]
**Deployment Status**: ‚úÖ SUCCESS | ‚ö†Ô∏è SKIPPED | ‚ùå FAILED
**Environment**: [environment-name if deployed]
**Deployed URL**: [url if available]

### Code Changes Applied

‚úÖ All changes from Section 2 applied successfully
- [Object 1 name] - Updated
- [Object 2 name] - Updated
- [etc.]

### DAX Validation Summary

**Validation Status**: ‚úÖ PASS | ‚ö†Ô∏è WARNINGS | ‚ùå FAIL
**Objects Reviewed**: [number]
**Critical Errors**: [number]
**Warnings**: [number]

**Detailed Validation Report**: [View Section 2.5](./findings.md#section-25-dax-validation-report)

[If PASS]
‚úÖ All DAX syntax and semantic checks passed. Code is ready for deployment.

[If WARNINGS]
‚ö†Ô∏è Non-critical issues detected. Deployment proceeded with accepted risks. Review Section 2.5 for details.

[If FAIL then fixed]
‚ùå Initial validation failed. Corrections applied and re-validated. Final status: PASS.

### Deployment Summary

[If deployed]
- **Method**: pbi-tools CLI
- **Target Workspace**: [workspace-name]
- **Dataset Name**: [dataset-display-name]
- **Deployment Time**: [duration]
- **Status**: [success/failure details]

[If skipped]
Deployment was not requested. To deploy manually:
```bash
cd [versioned-project-path]
pbi-tools deploy . [environment]
```

### Test Results Summary

[If tests ran]
**Tests Executed**: [number]
**Passed**: [number] ‚úÖ
**Failed**: [number] ‚ùå
**Errors**: [number] ‚ö†Ô∏è

**Detailed Results**: [View Test Results](./test-results/test_results.md)

**Screenshots**: [View Screenshots](./test-results/screenshots/)

[If tests skipped]
Testing was skipped. No dashboard URL available.

### Next Steps

[Recommendations based on results]
- [Action 1]
- [Action 2]
```

### Phase 7: Summary Report to User

Display final summary in CLI:

```
=================================================================
IMPLEMENTATION COMPLETE
=================================================================

‚úÖ Changes Applied
   Versioned Project: C:\path\to\project_20251003_143500

‚úÖ Deployment Successful [if deployed]
   Environment: DEV
   Dashboard: https://app.powerbi.com/reports/xyz789

‚úÖ Tests Passed: 8/8 [if tested]

üìÑ Full Report: agent_scratchpads/20251003-071759-pssr-misc/findings.md

=================================================================
```

## Error Handling

### Critical Errors (Abort Workflow)
- `--findings` file not found
- Project path not found in findings.md
- Project directory doesn't exist
- Code application fails (cannot apply changes)

Error Message Format:
```
‚ùå CRITICAL ERROR: [error description]

Workflow aborted. No changes have been made to your original project.

Resolution:
[Specific steps to fix the issue]
```

### Non-Critical Errors (Log and Continue)
- Deployment fails after code applied
- Test execution errors
- Screenshot capture issues

Warning Message Format:
```
‚ö†Ô∏è WARNING: [error description]

The workflow will continue. This issue has been logged in Section 4 of findings.md.
```

## Prerequisites

### For Code Application
- findings.md with Section 2 (Proposed Changes) populated
- Valid Power BI project path in findings.md metadata
- Sufficient disk space for versioned copy

### For Deployment (Optional)

**Two authentication methods are supported:**

#### Method 1: User Authentication (Recommended for Interactive Use)
- **Power BI PowerShell Module** installed
  ```powershell
  Install-Module -Name MicrosoftPowerBIMgmt -Scope CurrentUser
  ```
- **pbi-tools** installed (for PBIP ‚Üí PBIX compilation)
  - Download from: https://pbi.tools/
  - Verify: `pbi-tools --version`
- **Active Power BI login** (or ability to login interactively)
  ```powershell
  Connect-PowerBIServiceAccount
  ```
- **Workspace permissions**: Contributor or Admin role on target workspace

**Advantages:**
- ‚úÖ Uses your existing Power BI login
- ‚úÖ No Azure service principal setup required
- ‚úÖ Quick and easy for manual deployments
- ‚úÖ Automatically inherits your workspace permissions

#### Method 2: Service Principal Authentication (For CI/CD Automation)
- pbi-tools installed (`pbi-tools --version` works)
- Azure Service Principal configured (guided setup available)
- `.pbixproj.json` deployment manifest (auto-generated if missing)
- `PBI_CLIENT_SECRET` environment variable set
- Service principal authorized in Power BI tenant
- Service principal added as Contributor to target workspace

**Advantages:**
- ‚úÖ Unattended/automated deployments
- ‚úÖ CI/CD pipeline integration
- ‚úÖ No interactive login required
- ‚úÖ Consistent credentials across environments

**The agent will automatically detect which method to use:**
- If you're logged in ‚Üí Uses your login (Method 1)
- If not logged in ‚Üí Prompts you to choose between login or service principal

### For Testing (Optional)
- Playwright MCP available
- Dashboard URL accessible
- Power BI credentials configured in browser (if required)

## Configuration Files Generated

### `.pbixproj.json` (Only for Service Principal Authentication)

**Note:** This file is only created if you choose Service Principal authentication. User authentication doesn't require this file.

If using service principal, this file is created in the timestamped project directory:

```json
{
  "version": "0.16",
  "deployments": {
    "authentication": {
      "servicePrincipal": {
        "tenant": "contoso.onmicrosoft.com",
        "appId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "clientSecret": "%PBI_CLIENT_SECRET%"
      }
    },
    "environments": {
      "DEV": {
        "workspace": "PSSR Development",
        "displayName": "PSSR Commissions",
        "refresh": {
          "enabled": true,
          "method": "XMLA",
          "type": "full"
        }
      }
    }
  }
}
```

## Integration with evaluate-pbi-project-file

This command is designed as the second step in a two-phase workflow:

**Phase 1: Analysis**
```bash
/evaluate-pbi-project-file --project "C:\path\to\project" \
  --description "Problem description"
```
‚Üí Creates findings.md with Sections 1-3

**Phase 2: Implementation**
```bash
/implement-deploy-test-pbi-project-file \
  --findings "agent_scratchpads/YYYYMMDD-HHMMSS-problem/findings.md" \
  --deploy "DEV"
```
‚Üí Updates findings.md with Section 4, creates versioned project, deploys, tests

## Notes

- Original project is never modified (versioning ensures safety)
- Deployment profile configuration is interactive and user-guided
- Testing automatically uses Section 3 test cases if available
- All artifacts are consolidated in the scratchpad folder for easy reference
- Service principal setup is one-time; subsequent deployments use existing config
- The command is idempotent - can be re-run if deployment/testing fails
