# PBI Squire Plugin

Claude Code plugin for Power BI project analysis, modification, and deployment.

> **Note:** This CLAUDE.md is for **plugin developers**, not end users.
> End users get a minimal CLAUDE.md generated by bootstrap that references the plugin.

## Documentation Quick Reference

| What You Need | Where to Find It |
|---------------|------------------|
| **Main skill definition** | `skills/pbi-squire/SKILL.md` |
| **Workflow routing logic** | `skills/pbi-squire/references/orchestration-pattern.md` |
| **Visual flowcharts** | `project_documentation/workflow-diagrams.md` |
| **Developer features** | `skills/pbi-squire/developer-features.md` |
| **Git workflow** | `CONTRIBUTING.md` |
| **Development automation** | `dev/README.md` (gitignored) |

## What It Does

One comprehensive skill: **`pbi-squire`**

| Workflow | Purpose | Trigger Example |
|----------|---------|-----------------|
| EVALUATE | Diagnose and fix issues | "Fix this measure" |
| CREATE_ARTIFACT | Create new DAX measures/columns | "Create a YoY measure" |
| DATA_PREP | M code / Power Query transformations | "Filter this table" |
| SUMMARIZE | Document dashboards in business language | "Explain this dashboard" |
| IMPLEMENT | Apply planned changes | "Apply the changes" |
| MERGE | Compare and merge projects | "Merge these projects" |

The skill automatically routes requests to the appropriate workflow.

## Key Commands

| Command | Purpose |
|---------|---------|
| `/evaluate-pbi-project-file` | Analyze and diagnose issues |
| `/create-pbi-artifact-spec` | Create measures, columns, tables, visuals |
| `/implement-deploy-test-pbi-project-file` | Deploy and test changes |
| `/merge-powerbi-projects` | Compare and merge projects |

Or just describe what you need - the skill will route appropriately.

## Development

When working on this plugin codebase, consult `CONTRIBUTING.md` for:

- **Git operations** - Which branch to use (`main` vs `pro`)
- **Committing changes** - Feature branches, commit workflow
- **Merging/pushing** - Cascading changes from `main` to `pro`
- **Adding features** - Core (both versions) vs Developer features
- **Hotfixes** - Critical bug fix workflow

**Key rule:** Changes flow `main` → `pro`, never the reverse.

### Before ANY Commit

**STOP and verify:**

1. **Is this a Analyst feature or Developer feature?**
   - Core = benefits all users → branch from `main`
   - Pro = paid/advanced only → branch from `pro`
   - See `CONTRIBUTING.md` → "Pro-Only Features" and "Core Features" sections for complete lists

2. **Am I on the correct branch?**
   ```bash
   git branch  # Check current branch
   ```

3. **Will this need to cascade?**
   - Core changes → YES, cascade `main` → `pro` after merge
   - Pro changes → NO, stays in `pro` only

4. **What type of version bump is needed?**

   | Change Type | Bump | Example | When to Use |
   |-------------|------|---------|-------------|
   | **MAJOR** | `X.0.0` | `1.2.0` → `2.0.0` | Breaking changes, removed features, major restructure |
   | **MINOR** | `0.X.0` | `1.2.0` → `1.3.0` | New features, new workflows, new commands |
   | **PATCH** | `0.0.X` | `1.2.0` → `1.2.1` | Bug fixes, typos, small tweaks, documentation |

   **Before pushing, run:**
   ```powershell
   .\tools\sync-version.ps1 -Version "X.Y.Z"
   git add tools/developer/version.txt .claude-plugin/plugin.json
   ```

See `CONTRIBUTING.md` for detailed scenarios and commands.

### PowerShell File Encoding

**All generated files must be UTF-8 without BOM.** Windows PowerShell 5.1's `-Encoding UTF8` writes a BOM (`EF BB BF`) by default, which corrupts JSON files and breaks parsers.

| Method | BOM? | Safe? |
|--------|------|-------|
| `Set-Content -Encoding UTF8` | Yes (PS 5.1) | **No** |
| `Set-Content -Encoding UTF8NoBOM` | No (PS 7+ only) | Only on PS 7+ |
| `[System.IO.File]::WriteAllText($path, $content, (New-Object System.Text.UTF8Encoding $false))` | No | **Yes — use this** |

When writing PowerShell scripts that output JSON or other machine-readable files, always use `[System.IO.File]::WriteAllText()` with `UTF8Encoding($false)` to ensure cross-version compatibility. This applies to `plugin.json`, any generated config files, and tool output.

### Release Workflow

After pushing a version bump, create a GitHub release with release notes:

```powershell
# 1. Bump version and commit
.\tools\sync-version.ps1 -Version "1.4.0"
git add tools/developer/version.txt .claude-plugin/plugin.json
git commit -m "Bump version to 1.4.0"

# 2. Push and tag
git push origin main
git tag -a v1.4.0 -m "Release 1.4.0"
git push origin v1.4.0

# 3. Create GitHub release
gh release create v1.4.0 --title "v1.4.0" --notes "release notes here"

# 4. Cascade to pro and repeat for pro-origin
```

### Release Notes Template

```markdown
## What's New in X.Y.Z

### Features
- Added [feature] - [one-line description]

### Fixes
- Fixed [issue] - [what was wrong]

### Breaking Changes
- [Only if applicable - removal, API changes, etc.]

## Files Changed
- [List key files that changed]
```

**When to create releases:**

| Scenario | Create Release? |
|----------|-----------------|
| Version bump (MAJOR/MINOR/PATCH) | **Yes** |
| Internal refactor (no user impact) | Optional |
| Work-in-progress commits | No |

---

## Documentation Update Matrix

When modifying this plugin, **all affected documentation must be updated together**. Use these checklists to ensure consistency.

### Adding a New Workflow

| File | Action | Required |
|------|--------|----------|
| `skills/pbi-squire/workflows/<name>.md` | Create workflow documentation | Yes |
| `skills/pbi-squire/SKILL.md` | Add to "Trigger Actions" section | Yes |
| `skills/pbi-squire/SKILL.md` | Add to "Example Prompts" table | Yes |
| `skills/pbi-squire/references/orchestration-pattern.md` | Add to routing decision tree | Yes |
| `skills/pbi-squire/developer-features.md` | Add trigger + workflow section | If Pro |
| `CONTRIBUTING.md` | Add to "Pro-Only Features" table | If Pro |
| `.gitignore` (on `main` branch) | Add workflow path | If Pro |

### Adding a New Agent

| File | Action | Required |
|------|--------|----------|
| `agents/analyst/<name>.md` | Create agent (Analyst features) | If Core |
| `agents/developer/<name>.md` | Create agent (Developer features) | If Pro |
| `skills/pbi-squire/SKILL.md` | Add to "Specialist Agents" section | If orchestrated |
| `skills/pbi-squire/developer-features.md` | Add to "Pro Specialist Agents" | If Pro |
| `.claude-plugin/plugin.json` | Add to `agents` array | Yes |
| Workflow that invokes it | Reference the agent | Yes |
| `CONTRIBUTING.md` | Add to "Pro-Only Features" table | If Pro |
| `.gitignore` (on `main` branch) | Add agent path | If Pro |

### Adding a New Tool (Python)

| File | Action | Required |
|------|--------|----------|
| `tools/developer/<name>.py` | Create tool | If Core |
| `tools/developer/<name>.py` | Create tool | If Pro |
| `tools/bootstrap.ps1` | Add to `$CoreToolFiles` or `$AdvancedToolFiles` | Yes |
| `tools/bootstrap.sh` | Add to copy list | Yes |
| `CONTRIBUTING.md` | Add to "Pro-Only Features" table | If Pro |
| `.gitignore` (on `main` branch) | Add tool path | If Pro |

### Adding a New Reference Document

| File | Action | Required |
|------|--------|----------|
| `skills/pbi-squire/references/<name>.md` | Create reference | Yes |
| `skills/pbi-squire/SKILL.md` | Add to "References" section | If user-facing |
| `skills/pbi-squire/developer-features.md` | Add to "Pro References" | If Pro |
| Agents/workflows that use it | Add "See Also" or load instructions | Yes |
| `CONTRIBUTING.md` | Add to "Pro-Only Features" table | If Pro |
| `.gitignore` (on `main` branch) | Add reference path | If Pro |

### Adding a New Template (Bootstrap)

| File | Action | Required |
|------|--------|----------|
| `tools/templates/<name>` | Create template file | Yes |
| `tools/bootstrap.ps1` | Add copy logic | Yes |
| `tools/bootstrap.sh` | Add copy logic | Yes |
| `skills/pbi-squire/developer-features.md` | Document if Pro bootstrap feature | If Pro |

### Adding/Modifying Trigger Patterns

| File | Action | Required |
|------|--------|----------|
| `skills/pbi-squire/SKILL.md` | Update "Trigger Actions" | Yes |
| `skills/pbi-squire/references/orchestration-pattern.md` | Update routing decision tree | Yes |
| `skills/pbi-squire/developer-features.md` | Update "Pro Trigger Actions" | If Pro |

### Modifying a Skill's Capabilities

| File | Action | Required |
|------|--------|----------|
| `skills/<skill>/SKILL.md` | Update capability description | Yes |
| `CLAUDE.md` | Update "What It Does" table | If major change |
| `README.md` | Update feature list | If user-visible |
| `skills/pbi-squire/resources/getting-started.md` | Update if affects onboarding | If applicable |

---

## Documentation File Inventory

### Root Level
| File | Purpose | Update When |
|------|---------|-------------|
| `CLAUDE.md` | Plugin overview for Claude/developers | Skills or commands change |
| `CONTRIBUTING.md` | Git workflow, branch strategy, Developer features list | Adding Developer features, changing workflow |
| `README.md` | User installation guide | Installation process changes |
| `INSTALL.md` | Detailed installation steps | Installation process changes |

### Project Documentation (`project_documentation/`)
| File | Purpose | Update When |
|------|---------|-------------|
| `workflow-diagrams.md` | Mermaid flowcharts for FigJam/docs | Workflow routing or phases change |

### Skill Documentation (`skills/pbi-squire/`)
| File | Purpose | Update When |
|------|---------|-------------|
| `SKILL.md` | Main skill definition, triggers, workflows | Any capability change |
| `developer-features.md` | Developer features index | Adding Developer features |

### Resources (`skills/pbi-squire/resources/`)
| File | Purpose | Update When |
|------|---------|-------------|
| `getting-started.md` | User onboarding guide | Workflow or setup changes |
| `glossary.md` | Term definitions | New concepts introduced |
| `troubleshooting-faq.md` | Common issues | New error patterns discovered |
| `tracing-conventions.md` | Agent output formatting | Tracing format changes |

### References (`skills/pbi-squire/references/`)
| File | Purpose | Update When |
|------|---------|-------------|
| `ux-review-guidelines.md` | UX evaluation criteria | UX review process changes |
| `powerbi-design-standards.md` | Design constitution & critique rubric | Design standards change |
| `translation-guidelines.md` | Technical to business language | SUMMARIZE workflow changes |
| `query_folding_guide.md` | M code query folding rules | DATA_PREP workflow changes |
| `orchestration-pattern.md` | Routing logic | New workflows added |
| `command-parameters.md` | Parameter documentation | Command signatures change |

---

## Quick Validation Checklist

Before committing, verify:

- [ ] Trigger patterns in `SKILL.md` match routing in `references/orchestration-pattern.md`
- [ ] Trigger patterns in `project_documentation/workflow-diagrams.md` match the above
- [ ] New Pro files are listed in `CONTRIBUTING.md` Developer features table
- [ ] New Pro files are added to `.gitignore` on `main` branch
- [ ] Bootstrap scripts updated if new tools/templates added
- [ ] "See Also" sections reference related documentation
- [ ] Examples in "Example Prompts" table are current
- [ ] New agents added to `plugin.json` agents list

---

## Development Automation (Local Only)

The `dev/` folder (gitignored) contains development-only automation:

```
dev/
├── README.md              # Documentation locations guide
├── doc-update-prompt.md   # Instructions for updating docs
├── hooks/
│   └── on-workflow-change.ps1  # Hook script
└── skills/
    └── update-plugin-docs.md   # Dev-only skill
```

### Hooks (in your global ~/.claude/settings.json)

PostToolCall hooks trigger when you edit workflow files:
- `skills/pbi-squire/workflows/*.md`
- `skills/pbi-squire/SKILL.md`
- `agents/**/*.md`

The hook logs changes to `dev/pending-doc-updates.log` and reminds you to update docs.

### Updating Documentation

After modifying workflows, run:
```
/update-plugin-docs
```

Or manually follow `dev/doc-update-prompt.md`.
